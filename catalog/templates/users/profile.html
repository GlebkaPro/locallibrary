{% extends "base_generic.html" %}
{% block content %}
  {% load static %}
  <h1>Профиль</h1>
  <!-- Bootstrap Tabs -->
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if not request.GET.tab or request.GET.tab == 'profile' %}active{% endif %}"
              id="profile-tab"
              data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile"
              aria-selected="{% if not request.GET.tab or request.GET.tab == 'profile' %}true{% else %}false{% endif %}">
        Профиль
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if request.GET.tab == 'books' %}active{% endif %}" id="books-tab"
              data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab" aria-controls="books"
              aria-selected="{% if request.GET.tab == 'books' %}true{% else %}false{% endif %}">Мои книги
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if request.GET.tab == 'events' %}active{% endif %}" id="events-tab"
              data-bs-toggle="tab" data-bs-target="#events" type="button" role="tab" aria-controls="events"
              aria-selected="{% if request.GET.tab == 'events' %}true{% else %}false{% endif %}">Участие в мероприятиях
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if request.GET.tab == 'my_requests' %}active{% endif %}" id="my_requests-tab"
              data-bs-toggle="tab" data-bs-target="#my_requests" type="button" role="tab" aria-controls="my_requests"
              aria-selected="{% if request.GET.tab == 'my_requests' %}true{% else %}false{% endif %}">Мои заявки
      </button>
    </li>
  </ul>
  
  
<div class="tab-content" id="myTabContent">
<!-- Profile Tab Content -->
  <div class="tab-pane fade {% if not request.GET.tab or request.GET.tab == 'profile' %}show active{% endif %}"
       id="profile" role="tabpanel" aria-labelledby="profile-tab">
    <form method="post" enctype="multipart/form-data" class="card profile-container">
      {% csrf_token %}
      <div class="row" style="padding: 10px">
        <div class="col-md-4 text-center">
          <div class="image-container" >
            {% if user.avatar %}
              <img src="{{ user.avatar.url }}" class="img-fluid avatar-img" alt="Аватар">
            {% else %}
              <img src="/images/users/default.png" class="img-fluid avatar-img" alt="Заполнитель: Эскиз">
            {% endif %}
          </div>
          <div class="mb-3 d-flex justify-content-center">
            <input type="file" class="form-control custom-file" id="{{ form.avatar.id_for_label }}"
                   name="{{ form.avatar.name }}" style="max-width: 300px">
            <div class="form-error">{{ form.avatar.errors }}</div>
          </div>
          <div class="mb-3">
            <label for="{{ form.username.id_for_label }}" class="form-label">Имя пользователя</label>
            <input type="text" class="form-control" id="{{ form.username.id_for_label }}"
                   name="{{ form.username.name }}" value="{{ user.username }}" readonly>
            <div class="form-error">{{ form.username.errors }}</div>
          </div>
          <div class="mb-3">
            <label for="{{ form.email.id_for_label }}">Email</label>
            <input type="text" class="form-control" id="{{ form.email.id_for_label }}" name="{{ form.email.name }}"
                   value="{{ user.email }}">
            <div class="form-error">{{ form.email.errors }}</div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="text-container card-body">
            <div class="mb-3">
              <label for="{{ form.last_name.id_for_label }}" class="form-label">Фамилия</label>
              <input type="text" class="form-control" id="{{ form.last_name.id_for_label }}"
                     name="{{ form.last_name.name }}" value="{{ user.last_name }}" style="max-width: 300px">
              <div class="form-error">{{ form.last_name.errors }}</div>
            </div>
            <div class="mb-3">
              <label for="{{ form.first_name.id_for_label }}" class="form-label">Имя</label>
              <input type="text" class="form-control" id="{{ form.first_name.id_for_label }}"
                     name="{{ form.first_name.name }}" value="{{ user.first_name }}" style="max-width: 300px">
              <div class="form-error">{{ form.first_name.errors }}</div>
            </div>
            <div class="mb-3">
              <label for="{{ form.middle_name.id_for_label }}" class="form-label">Отчество</label>
              <input type="text" class="form-control" id="{{ form.middle_name.id_for_label }}"
                     name="{{ form.middle_name.name }}" value="{{ user.middle_name }}" style="max-width: 300px">
              <div class="form-error">{{ form.middle_name.errors }}</div>
            </div>
            <div class="mb-3">
              <label for="{{ form.date_birth.id_for_label }}" class="form-label">Дата рождения</label>
              <input type="text" class="form-control" id="{{ form.date_birth.id_for_label }}"
                     name="{{ form.date_birth.name }}" value="{{ user.date_birth }}" style="max-width: 300px">
              <div class="form-error">{{ form.date_birth.errors }}</div>
            </div>
            <div class="mb-3">
              <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
            <div class="form-error">{{ form.non_field_errors }}</div>
            <div class="form-error">{{ form.date_birth.errors }}</div>
          </div>
        </div>
      </div>
    </form>
  </div>



  <!-- Books Tab Content -->
  <div class="tab-pane fade {% if request.GET.tab == 'books' %}show active{% endif %}" id="books" role="tabpanel"
       aria-labelledby="books-tab">
    <div>
      {% if bookinstance_list %}
        <table class="table table table-card">
    <thead>
        <tr>
            <th>№</th>
            <th>Название книги</th>
            <th>Штамп</th>
            <th style="cursor:pointer;" data-sort="date-start" data-order="desc">Дата начала &#9660;</th>
            <th style="cursor:pointer;" data-sort="date-end" data-order="desc">Дата окончания &#9660;</th>
            <th style="cursor:pointer;" data-sort="renewal-date" data-order="desc">Дата продления &#9660;</th>
            <th>Статус</th>
            <th>Действие</th>
        </tr>
    </thead>
    <tbody>
        {% for bookinst in bookinstance_list %}
        <tr class="{% if bookinst.is_overdue %}text-danger{% endif %} {% if bookinst.status == 'р' %}table-success{% elif bookinst.status == 'з' %}table-warning{% elif bookinst.status == 'д' %}table-info{% endif %}">
            <td>{{ forloop.counter }}</td>
            <td>
                <a href="{% url 'book-detail' bookinst.book.pk %}">{{ bookinst.book.title }}</a>
            </td>
            <td>{{ bookinst.loan.imprint }}</td>
            <td>{{ bookinst.current_date }}</td>
            <td>{{ bookinst.due_back|default_if_none:"-" }}</td>
            <td>{{ bookinst.renewal_date|default_if_none:"-" }}</td>
            <td>{{ bookinst.get_status_display }}</td>
            <td>
                {% if bookinst.status == 'р' %}
                <a href="{% url 'renew-book-librarian' bookinst.id %}" class="btn btn-warning">Продлить</a>
                {% elif bookinst.status == 'з' %}
                <form action="{% url 'cancel_reservation' bookinst.id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Вы уверены?')">Отменить резерв</button>
                </form>
                {% else %}
                <span class="text-danger">Невозможно выполнить действие</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

      {% else %}
        <p>У вас нет взятых книг.</p>
      {% endif %}
    </div>
  </div>


  <!-- Events Tab Content -->
  <div class="tab-pane fade {% if request.GET.tab == 'events' %}show active{% endif %}" id="events" role="tabpanel"
       aria-labelledby="events-tab">
<table class="table table table-card" id="eventsTable">
  <thead>
  <tr>
    <th>№</th>
    <th>Название мероприятия</th>
    <th style="cursor:pointer;" data-sort="date" data-order="desc">Дата начала &#9660;</th>
    <th style="cursor:pointer;" data-sort="date-end" data-order="desc">Дата окончания &#9660;</th>
    <th>Статус</th>
    <th>Действия</th>
  </tr>
  </thead>
  <tbody>
  {% for event in registered_events %}
    <tr {% if event.status_record == 'з' %}class="table-success"
        {% elif event.status_record == 'н' %}class="table-danger"{% endif %}>
      <td>{{ forloop.counter }}</td>
      <td><a href="{% url 'detail_event' event_id=event.event.id %}">{{ event.event.event_name }}</a></td>
      <td>{{ event.event.date_start }}</td>
      <td>{{ event.event.date_end }}</td>
      <td>
        {% if event.status_record == 'з' %}
          Записан
        {% elif event.status_record == 'н' %}
          Не записан
        {% endif %}
      </td>
      <td>
        {% if event.event.date_end|date:"Y-m-d" > now|date:"Y-m-d" %}
          Окончено
        {% else %}
          {% if event.status_record == 'з' %}
            <form action="{% url 'cancel_registration' registration_id=event.id %}" method="post" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger" onclick="return confirm('Вы уверены?')">Отменить регистрацию</button>
            </form>
          {% elif event.status_record == 'н' %}
            <form action="{% url 'profile_register_to_event' registration_id=event.id %}" method="post" style="display: inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-success">Зарегистрироваться вновь</button>
            </form>
          {% endif %}
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="6">Вы не зарегистрированы ни на одно мероприятие.</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

  </div>


  <!-- Requests Tab Content -->
  <div class="tab-pane fade {% if request.GET.tab == 'my_requests' %}show active{% endif %}" id="my_requests"
       role="tabpanel" aria-labelledby="my_requests-tab">

    <table class="table table table-card" id="positions_table">
      <thead>
      <tr>
        <th>№</th>
        <th>Название книги</th>
        <th>Автор</th>
        <th>Описание</th>
        <th style="cursor:pointer;" data-sort="date" data-order="desc">Дата создания &#9660;</th>
        <th>Статус</th>
        <th>Причина</th>
        <th>Действия</th>
      </tr>
      </thead>
      <tbody>
      {% for request in user_requests %}
        <tr
          class="{% if request.status_record == 'п' %}table-success{% elif request.status_record == 'з' %}table-danger{% elif request.status_record == 'в' %}table-warning{% elif request.status_record == 'о' %}table-secondary{% endif %}">
          <td>{{ forloop.counter }}</td>
          <td>{{ request.title }}</td>
          <td>{{ request.author }}</td>
          <td>{{ request.description|slice:":30" }}</td>
          <td>{{ request.date_creation }}</td>
          <td>{{ request.get_status_record_display }}</td>
          <td>{{ request.reason|slice:":30"|default_if_none:"-" }}</td>
          <td>
            {% if request.status_record == 'в' %}
              <a href="{% url 'edit_request' request_id=request.id %}" class="btn btn-warning">Редактировать</a>
              <form action="{% url 'profile_delete_request' request_id=request.id %}" method="post"
                    style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger"
                        onclick="return confirm('Вы уверены?')">Удалить
                </button>
              </form>
            {% else %}
              <span class="text-danger">Невозможно редактировать или удалять</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7">У вас нет заявок.</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div>
      <a href="{% url 'create_request' %}" class="btn btn-primary mb-3">Создать заявку</a>
    </div>
  </div>
  

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('th[data-sort]').forEach(header => {
        header.addEventListener('click', function () {
          let table = header.closest('table');
          let tbody = table.querySelector('tbody');
          let isAscending = header.getAttribute('data-order') === 'asc';
          let type = header.getAttribute('data-sort');
          let rows = Array.from(tbody.querySelectorAll('tr'));

          // Инвертируем направление сортировки при каждом клике
          isAscending = !isAscending;

          // Обновляем символы для отображения текущего направления сортировки
          if (isAscending) {
            header.setAttribute('data-order', 'asc');
            header.innerHTML = header.innerHTML.replace('&#9660;', '&#9650;'); // Изменение символа на "вверх"
          } else {
            header.setAttribute('data-order', 'desc');
            header.innerHTML = header.innerHTML.replace('&#9650;', '&#9660;'); // Изменение символа на "вниз"
          }

          rows.sort(function (a, b) {
            let aText, bText;
            if (type === 'date' || type === 'date-start' || type === 'date-end') {
              // Преобразуем текст ячейки в объект Date для корректной сортировки
              aText = new Date(a.cells[3].textContent);
              bText = new Date(b.cells[3].textContent);
            } else { // status
              aText = a.cells[6].textContent.trim();
              bText = b.cells[6].textContent.trim();
            }

            // Учитываем направление сортировки
            return (aText < bText ? -1 : 1) * (isAscending ? 1 : -1);
          });

          // Перестраиваем строки в теле таблицы
          rows.forEach(row => tbody.appendChild(row));
        });
      });
    });
  </script>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Находим все кнопки вкладок
      const tabButtons = document.querySelectorAll('.nav-link');

      // Добавляем обработчик события клика для каждой кнопки вкладки
      tabButtons.forEach(function (button) {
        button.addEventListener('click', function (event) {
          // Отменяем стандартное поведение ссылки
          {#event.preventDefault();#}

          // Удаляем класс 'active' у всех кнопок вкладок
          tabButtons.forEach(function (btn) {
            btn.classList.remove('active');
          });

          // Добавляем класс 'active' только к нажатой кнопке вкладки
          button.classList.add('active');

          // Получаем целевую вкладку по атрибуту data-bs-target кнопки вкладки
          const targetTabId = button.getAttribute('data-bs-target');

          // Находим все вкладки содержимого
          const tabContents = document.querySelectorAll('.tab-pane');

          // Скрываем все вкладки содержимого
          tabContents.forEach(function (tab) {
            tab.classList.remove('show', 'active');
          });

          // Показываем только целевую вкладку содержимого
          const targetTab = document.querySelector(targetTabId);
          targetTab.classList.add('show', 'active');
        });
      });
    });
  </script>
  <style>

  </style>
{% endblock %}



